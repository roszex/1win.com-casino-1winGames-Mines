<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>–í–∞—à –ø—Ä–æ–≥–Ω–æ–∑</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="styles/prediction.css?v=1.4.0">
  </head>
  <body>
    <h1>–í–∞—à –ø—Ä–æ–≥–Ω–æ–∑</h1>
    
    <div class="game-field" id="gameField">
      <div class="loading">–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞—à –ø—Ä–æ–≥–Ω–æ–∑...</div>
    </div>
    
    <div class="stats-row" id="statsRow" style="display: none;">
      <div class="stat-item">
        <div class="stat-icon">üí£</div>
        <div class="stat-label">–ú–∏–Ω—ã</div>
        <div class="stat-value" id="minesCount">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-icon">‚≠ê</div>
        <div class="stat-label">–ó–≤–µ–∑–¥—ã</div>
        <div class="stat-value" id="starsCount">0</div>
      </div>
    </div>
    
    <button class="finish-btn" onclick="finish()" id="finishBtn" style="display: none;">
      –ó–∞–∫–æ–Ω—á–∏—Ç—å
    </button>

    <script>
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp –¥–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
      function initTelegramWebApp() {
        if (window.Telegram && window.Telegram.WebApp) {
          const tg = window.Telegram.WebApp;
          
          try {
            // –†–∞—Å—à–∏—Ä—è–µ–º WebApp –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
            tg.expand();
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
            if (tg.requestFullscreen) {
              tg.requestFullscreen();
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç–∞ —Ç–µ–º—ã –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
            tg.setHeaderColor('#000000');
            tg.setBackgroundColor('#000000');
            
            // –û—Ç–∫–ª—é—á–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è "–∏–∑–º–µ–Ω–µ–Ω–∏—è –º–æ–≥—É—Ç –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è"
            if (tg.enableClosingConfirmation) {
              // –ù–µ –≤–∫–ª—é—á–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (tg.MainButton) {
              tg.MainButton.hide();
            }
            
            console.log('Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ');
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram WebApp:', error);
          }
        } else {
          console.log('Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –∑–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ –±—Ä–∞—É–∑–µ—Ä–∞');
        }
      }
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WebApp
      initTelegramWebApp();
      
      // –£–±–∏—Ä–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ - —ç–ª–µ–º–µ–Ω—Ç—ã —Å—Ç–∞—Ç–∏—á–Ω—ã
      
      function loadPrediction() {
        fetch('/api/game-data')
          .then(response => response.json())
          .then(data => {
            if (data.lastGame && data.lastGame.minePositions.length > 0) {
              displayGame(data.lastGame);
            } else {
              document.getElementById('gameField').innerHTML = '<div class="loading">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–≥–Ω–æ–∑–µ</div>';
            }
          })
          .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞:', error);
            document.getElementById('gameField').innerHTML = '<div class="loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞</div>';
          });
      }

      function displayGame(gameData) {
        const gameField = document.getElementById('gameField');
        
        // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —è—á–µ–µ–∫
        gameField.innerHTML = '<div class="cells-container"></div>';
        const cellsContainer = gameField.querySelector('.cells-container');
        
        const minePositions = new Set(gameData.minePositions);
        const starPositions = new Set(gameData.starPositions);
        
        for (let row = 0; row < 5; row++) {
          for (let col = 0; col < 5; col++) {
            const cellId = row * 5 + col;
            
            const cell = document.createElement('div');
            cell.className = 'game-cell revealed';
            
            if (minePositions.has(cellId)) {
              cell.classList.add('mine');
              cell.innerHTML = '<img src="mines.png" alt="mine" class="mine-image">';
            } else {
              cell.classList.add('star');
              cell.innerHTML = '<img src="star.png" alt="star" class="star-image">';
            }
            
            cellsContainer.appendChild(cell);
          }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
        document.getElementById('minesCount').textContent = minePositions.size;
        document.getElementById('starsCount').textContent = starPositions.size;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –∏ –∫–Ω–æ–ø–∫—É
        document.getElementById('statsRow').style.display = 'flex';
        document.getElementById('finishBtn').style.display = 'block';
      }

      function finish() {
        // –ê–Ω–∏–º–∞—Ü–∏—è –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.body.style.transition = 'opacity 0.2s ease-out, transform 0.2s ease-out';
        document.body.style.opacity = '0';
        document.body.style.transform = 'translateY(20px)';
        
        // –ü–µ—Ä–µ—Ö–æ–¥ –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
        setTimeout(() => {
          window.location.href = '/';
        }, 200);
      }

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥–Ω–æ–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      loadPrediction();
    </script>
  </body>
</html>
